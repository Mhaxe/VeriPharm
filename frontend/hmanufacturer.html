<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manufacturer Dashboard | Veripharm</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
  :root {
    --primary-blue: #007BFF;
    --light-bg: #f0f8ff;
    --white: #ffffff;
    --gray: #666;
    --font: 'Plus Jakarta Sans', sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: var(--font);
    background: var(--light-bg);
    color: #333;
    transition: background 0.5s, color 0.5s;
  }
  body.dark-mode {
    background-color: #1e1e2f;
    color: #f0f0f0;
  }
  header {
    background: var(--primary-blue);
    color: white;
    padding: 20px 30px;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header a {
    color: white;
    text-decoration: underline;
    font-size: 16px;
  }
  .theme-toggle {
    background: none;
    border: 2px solid white;
    color: white;
    border-radius: 20px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 18px;
  }
  .container {
    max-width: 1100px;
    margin: 40px auto;
    padding: 20px;
    background: var(--white);
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  }
  body.dark-mode .container {
    background-color: #2e2e3e;
    color: #f0f0f0;
  }
  h2 {
    color: var(--primary-blue);
    font-size: 22px;
    margin-top: 40px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h2::before {
    content: '▶';
    font-size: 14px;
  }
  body.dark-mode h2 {
    color: #66b2ff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    padding: 12px;
    border: 1px solid #ccc;
    text-align: left;
  }
  body.dark-mode th, body.dark-mode td {
    border-color: #444;
  }
  .notice {
    background: #fff3cd;
    border-left: 6px solid #ffc107;
    padding: 15px;
    margin-top: 20px;
    border-radius: 5px;
    font-weight: 500;
  }
  body.dark-mode .notice {
    background: #332b00;
    border-left-color: #ffd700;
  }
  input, select, textarea, button {
    display: block;
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    margin-bottom: 20px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 16px;
  }
  body.dark-mode input, 
  body.dark-mode select, 
  body.dark-mode textarea {
    background-color: #3a3a4a;
    color: #f0f0f0;
    border-color: #555;
  }
  button {
    background-color: var(--primary-blue);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s ease-in-out;
  }
  button:hover {
    background-color: #0056b3;
    transform: scale(1.05);
  }
  .success {
    background-color: #d4edda;
    color: #155724;
    padding: 12px;
    border-left: 5px solid #28a745;
    border-radius: 5px;
    margin-top: 20px;
  }
  .section {
    opacity: 0;
    transform: translateY(50px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }
  .section.visible {
    opacity: 1;
    transform: translateY(0);
  }
  @keyframes pulseFlash {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.08); }
  }
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .drug-category {
    margin-bottom: 15px;
    background: rgba(0,123,255,0.05);
    border-radius: 8px;
    padding: 10px;
    transition: all 0.3s ease;
  }
  body.dark-mode .drug-category {
    background: rgba(102,178,255,0.05);
  }
  .category-header {
    font-weight: 600;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
  }
  .category-header:hover {
    background: rgba(0,123,255,0.1);
  }
  body.dark-mode .category-header:hover {
    background: rgba(102,178,255,0.1);
  }
  .drug-list {
    margin-left: 15px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .drug-list.expanded {
    max-height: 500px;
  }
  .drug-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed #ddd;
  }
  body.dark-mode .drug-item {
    border-bottom-color: #444;
  }
  .transfer-log {
    max-height: 300px;
    overflow-y: auto;
  }
  .transfer-log-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 10px;
  }
  body.dark-mode .transfer-log-item {
    border-bottom-color: #444;
  }
  .toggle-icon {
    transition: transform 0.3s ease;
    font-size: 18px;
  }
  .drug-list.expanded + .category-header .toggle-icon {
    transform: rotate(90deg);
  }
  .add-drug-form {
    margin-top: 30px;
    padding: 20px;
    background: rgba(0,123,255,0.05);
    border-radius: 8px;
  }
  body.dark-mode .add-drug-form {
    background: rgba(102,178,255,0.05);
  }
  .form-row {
    display: flex;
    gap: 15px;
  }
  .form-row > div {
    flex: 1;
  }
  .analytics-section {
    margin-top: 30px;
    padding: 20px;
    background: rgba(0,123,255,0.05);
    border-radius: 8px;
  }
  body.dark-mode .analytics-section {
    background: rgba(102,178,255,0.05);
  }
  .analytics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 15px;
  }
  .analytics-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  body.dark-mode .analytics-card {
    background-color: #2e2e3e;
  }
  .analytics-card h3 {
    margin-top: 0;
    color: var(--primary-blue);
    font-size: 18px;
  }
  body.dark-mode .analytics-card h3 {
    color: #66b2ff;
  }
  .analytics-list {
    list-style-type: none;
    padding: 0;
    margin: 10px 0 0 0;
  }
  .analytics-list li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
  }
  body.dark-mode .analytics-list li {
    border-bottom-color: #444;
  }
  .analytics-list li:last-child {
    border-bottom: none;
  }
  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .popup-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  .popup-content {
    background: var(--white);
    padding: 25px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
  }
  body.dark-mode .popup-content {
    background-color: #2e2e3e;
  }
  .popup-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--gray);
  }
  .popup-title {
    margin-top: 0;
    color: var(--primary-blue);
  }
  body.dark-mode .popup-title {
    color: #66b2ff;
  }
  .info-icon {
    cursor: pointer;
    margin-left: 8px;
    font-style: normal;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background: var(--primary-blue);
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: bold;
  }
  body.dark-mode .info-icon {
    background: #66b2ff;
  }
  .error {
    background-color: #f8d7da;
    color: #721c24;
    padding: 12px;
    border-left: 5px solid #dc3545;
    border-radius: 5px;
    margin-top: 20px;
  }
  /* Custom select arrow styling */
  select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: var(--white);
    border: 2px solid var(--primary-blue);
    padding-right: 48px;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23007BFF" height="28" viewBox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="%23007BFF"/><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 28px 28px;
    font-weight: 600;
    color: var(--primary-blue);
    transition: border-color 0.3s;
  }
  select:focus {
    border-color: #0056b3;
    outline: none;
  }
  body.dark-mode select {
    background-color: #3a3a4a;
    color: #66b2ff;
    border-color: #66b2ff;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%2366b2ff" height="28" viewBox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="%2366b2ff"/><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  }
  select::-ms-expand {
    display: none;
  }
  </style>
</head>
<body>
  <header>
    <span>Veripharm - Manufacturer Dashboard</span>
    <div>
      <a href="about page.html">About Veripharm</a>
      <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
    </div>
  </header>

  <div class="container">
    <div class="section">
      <!-- Inventory section header with retractable arrow -->
      <h2 id="inventory-toggle-header" style="cursor:pointer;user-select:none;">
        <span id="inventory-toggle-arrow" style="font-size:18px;">►</span>
        Drug Inventory by Category
      </h2>
      <div class="dashboard-grid" id="inventory-section" style="display:none;">
        <div id="inventory-column">
          <!-- Drug categories and drugs rendered here by JS -->
        </div>
      </div>
      <!-- Transfer Medication section header with its own retractable arrow -->
      <h2 id="transfer-toggle-header" style="cursor:pointer;user-select:none;">
        <span id="transfer-toggle-arrow" style="font-size:18px;">►</span>
        Transfer Medication
      </h2>
      <div id="transfer-section" style="display:none;">
        <form id="transferForm" class="section">
          <!-- Transfer form fields -->
          <select id="drugCategory" required>
            <option value="">Select Drug Category</option>
            <!-- [Category options, see your file for full list] -->
            <option value="antibiotics">Antibiotics</option>
            <option value="antimalarials">Antimalarials</option>
            <option value="analgesics">Analgesics</option>
            <option value="opioids">Opioids</option>
            <option value="antihypertensives">Antihypertensives</option>
            <option value="antidiabetics">Antidiabetics</option>
            <option value="antacids">Antacids/PPIs</option>
            <option value="vitamins">Vitamin Supplements</option>
            <option value="glaucoma">Glaucoma Medications</option>
            <option value="antifungals">Antifungals</option>
            <option value="decongestants">Decongestants</option>
            <option value="general_creams">General Creams</option>
            <option value="topical_agents">Topical Agents</option>
            <option value="antidepressants">Antidepressants</option>
            <option value="corticosteroids">Corticosteroids</option>
            <option value="antivirals">Antivirals</option>
            <option value="anthelmintics">Anthelmintics (Dewormers)</option>
            <option value="antituberculars">Antituberculars</option>
            <option value="antiretrovirals">Antiretrovirals (HIV/AIDS)</option>
            <option value="antihistamines">Antihistamines</option>
            <option value="antidiarrheals">Antidiarrheals</option>
            <option value="antiseptics">Antiseptics/Disinfectants</option>
            <option value="hematinics">Hematinics</option>
            <option value="eye_ear_preparations">Eye/Ear Preparations</option>
          </select>
          <select id="drugSelection" required disabled>
            <option value="">Select Drug</option>
          </select>
          <input type="number" id="transferQuantity" placeholder="Quantity" min="1" required>
          <input type="text" id="destination" placeholder="Enter pharmacy name" required>
          <div class="form-row">
            <div>
              <label for="transfer_batch_id">Batch ID</label>
              <input type="text" id="transfer_batch_id" placeholder="Enter batch ID" required>
            </div>
          </div>
          <div>
            <label for="transfer_description">Description / Notes</label>
            <textarea id="transfer_description" rows="3" placeholder="Optional comments or special instructions..."></textarea>
          </div>
          <button type="submit">Initiate Transfer</button>
        </form>
        <div class="section">
          <h2>Recent Transfers</h2>
          <div class="transfer-log" id="transferLog"></div>
        </div>
        <!-- Analytics Section -->
        <div class="analytics-section">
          <h2>Drug Distribution Analytics</h2>
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>Top 5 Requested Drugs</h3>
              <ul class="analytics-list" id="topDrugsList"></ul>
            </div>
            <div class="analytics-card">
              <h3>Top 5 Delivery Locations</h3>
              <ul class="analytics-list" id="topLocationsList"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Add New Drug Form -->
    <div class="add-drug-form">
      <h2>Add New Batch</h2>
      <form id="addDrugForm">
        <div class="form-row">
          <div>
            <label for="newDrugCategory">Category</label>
            <select id="newDrugCategory" required>
              <option value="">Select Category</option>
              <!-- [Category options, see your file for full list] -->
              <option value="antibiotics">Antibiotics</option>
              <option value="antimalarials">Antimalarials</option>
              <option value="analgesics">Analgesics</option>
              <option value="opioids">Opioids</option>
              <option value="antihypertensives">Antihypertensives</option>
              <option value="antidiabetics">Antidiabetics</option>
              <option value="antacids">Antacids/PPIs</option>
              <option value="vitamins">Vitamin Supplements</option>
              <option value="glaucoma">Glaucoma Medications</option>
              <option value="antifungals">Antifungals</option>
              <option value="decongestants">Decongestants</option>
              <option value="general_creams">General Creams</option>
              <option value="topical_agents">Topical Agents</option>
              <option value="antidepressants">Antidepressants</option>
              <option value="corticosteroids">Corticosteroids</option>
              <option value="antivirals">Antivirals</option>
              <option value="anthelmintics">Anthelmintics (Dewormers)</option>
              <option value="antituberculars">Antituberculars</option>
              <option value="antiretrovirals">Antiretrovirals (HIV/AIDS)</option>
              <option value="antihistamines">Antihistamines</option>
              <option value="antidiarrheals">Antidiarrheals</option>
              <option value="antiseptics">Antiseptics/Disinfectants</option>
              <option value="hematinics">Hematinics</option>
              <option value="eye_ear_preparations">Eye/Ear Preparations</option>
            </select>
          </div>
          <div>
            <label for="newDrugName">Drug Name</label>
            <input type="text" id="newDrugName" list="drugSuggestions" placeholder="Enter drug name or select" required>
            <datalist id="drugSuggestions"></datalist>
          </div>
        </div>
        <div>
          <label for="newDrugQuantity">Quantity</label>
          <input type="number" id="newDrugQuantity" placeholder="Enter quantity" min="1" required>
        </div>
        <div class="form-row">
          <div>
            <label for="add_batch_id">Batch ID</label>
            <input type="text" id="add_batch_id" placeholder="Enter batch ID" required>
          </div>
          <div>
            <label for="manufacturing_date">Manufacturing Date</label>
            <input type="date" id="manufacturing_date" required>
          </div>
          <div>
            <label for="expiry_date">Expiry Date</label>
            <input type="date" id="expiry_date" required>
          </div>
        </div>
        <button type="submit">Add Drug to Inventory</button>
      </form>
    </div>
    <div class="section notice">
      Important: Please ensure that all medication packages are tagged with QR codes prior to transfer.
    </div>
  </div>

  <!-- Popup Modal for category info -->
  <div class="popup-overlay" id="categoryPopup">
    <div class="popup-content">
      <button class="popup-close" onclick="closePopup()">×</button>
      <h3 class="popup-title" id="popupCategoryTitle">Category</h3>
      <p id="popupCategoryDescription">Description will appear here.</p>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- Drug Database ---
    // Holds all categories and their drugs, including batch numbers.
    const drugDatabase = {
      antibiotics: [
        { name: 'Amoxicillin-Clavulanic Acid', quantity: 50, batchNumbers: [] },
        { name: 'Ciprofloxacin', quantity: 20, batchNumbers: [] },
        { name: 'Azithromycin', quantity: 15, batchNumbers: [] }
      ],
      antimalarials: [
        { name: 'Artemether-Lumefantrine', quantity: 120, batchNumbers: [] }
      ],
      analgesics: [
        { name: 'Ibuprofen', quantity: 60, batchNumbers: [] },
        { name: 'Paracetamol', quantity: 30, batchNumbers: [] }
      ],
      opioids: [
        { name: 'Tramadol', quantity: 30, batchNumbers: [] }
      ],
      antihypertensives: [
        { name: 'Lisinopril', quantity: 55, batchNumbers: [] }
      ],
      antidiabetics: [
        { name: 'Metformin', quantity: 95, batchNumbers: [] }
      ],
      antacids: [
        { name: 'Omeprazole', quantity: 20, batchNumbers: [] }
      ],
      vitamins: [
        { name: 'Iron + Folic Acid', quantity: 200, batchNumbers: [] }
      ],
      glaucoma: [
        { name: 'Latanoprost', quantity: 15, batchNumbers: [] }
      ],
      antifungals: [
        { name: 'Clotrimazole', quantity: 40, batchNumbers: [] }
      ],
      decongestants: [
        { name: 'Pseudoephedrine', quantity: 45, batchNumbers: [] },
        { name: 'Diphenhydramine syrup', quantity: 30, batchNumbers: [] },
        { name: 'Dextromethorphan syrup', quantity: 30, batchNumbers: [] }
      ],
      antivirals: [
        { name: 'Acyclovir', quantity: 25, batchNumbers: [] }
      ],
      corticosteroids: [
        { name: 'Prednisone', quantity: 25, batchNumbers: [] }
      ],
      antidepressants: [
        { name: 'Fluoxetine', quantity: 25, batchNumbers: [] }
      ],
      topical_agents: [
        { name: 'Hydrocortisone Cream', quantity: 25, batchNumbers: [] }
      ],
      general_creams: [
        { name: 'Moisturizing Cream', quantity: 25, batchNumbers: [] }
      ],
      anthelmintics: [
        { name: 'Albendazole', quantity: 40, batchNumbers: [] },
        { name: 'Mebendazole', quantity: 30, batchNumbers: [] },
        { name: 'Praziquantel', quantity: 20, batchNumbers: [] }
      ],
      antituberculars: [
        { name: 'Isoniazid', quantity: 25, batchNumbers: [] },
        { name: 'Rifampicin', quantity: 25, batchNumbers: [] },
        { name: 'Ethambutol', quantity: 20, batchNumbers: [] },
        { name: 'Pyrazinamide', quantity: 20, batchNumbers: [] }
      ],
      antiretrovirals: [
        { name: 'Zidovudine (AZT)', quantity: 30, batchNumbers: [] },
        { name: 'Lamivudine (3TC)', quantity: 30, batchNumbers: [] },
        { name: 'Efavirenz', quantity: 30, batchNumbers: [] },
        { name: 'Tenofovir', quantity: 30, batchNumbers: [] }
      ],
      antihistamines: [
        { name: 'Chlorpheniramine', quantity: 40, batchNumbers: [] },
        { name: 'Cetirizine', quantity: 35, batchNumbers: [] },
        { name: 'Loratadine', quantity: 30, batchNumbers: [] }
      ],
      antidiarrheals: [
        { name: 'Oral Rehydration Salts (ORS)', quantity: 100, batchNumbers: [] },
        { name: 'Loperamide', quantity: 40, batchNumbers: [] }
      ],
      antiseptics: [
        { name: 'Chlorhexidine', quantity: 50, batchNumbers: [] },
        { name: 'Povidone-iodine', quantity: 30, batchNumbers: [] }
      ],
      hematinics: [
        { name: 'Ferrous sulfate', quantity: 80, batchNumbers: [] },
        { name: 'Folic acid', quantity: 80, batchNumbers: [] }
      ],
      eye_ear_preparations: [
        { name: 'Gentamicin eye/ear drops', quantity: 25, batchNumbers: [] },
        { name: 'Tetracycline eye ointment', quantity: 25, batchNumbers: [] }
      ]
    };

    // --- Analytics Counters ---
    // Used for analytics display (top drugs, locations).
    const transferCounts = {};
    const locationCounts = {};

    // --- Category Descriptions ---
    // Human-readable descriptions for each drug category.
    const categoryDefinitions = {
      antibiotics: "Medicines that fight bacterial infections by killing or slowing the growth of bacteria.",
      antimalarials: "Drugs used to prevent and treat malaria, a disease caused by parasites.",
      analgesics: "Medications that relieve pain without causing loss of consciousness.",
      opioids: "Strong pain relievers that can also produce euphoria and are potentially addictive.",
      antihypertensives: "Drugs used to treat high blood pressure (hypertension).",
      antidiabetics: "Medications that help control blood sugar levels in people with diabetes.",
      antacids: "Medicines that neutralize stomach acid to relieve heartburn or indigestion.",
      vitamins: "Nutritional supplements that provide essential vitamins and minerals.",
      glaucoma: "Eye drops or medications that reduce pressure in the eye for glaucoma patients.",
      antifungals: "Medicines that treat fungal infections like athlete's foot or yeast infections.",
      decongestants: "Medications that relieve nasal congestion in the upper respiratory tract.",
      antivirals: "Medications that treat viral infections such as influenza, herpes, or hepatitis.",
      corticosteroids: "Drugs that reduce inflammation and suppress the immune system, used in asthma, allergies, and autoimmune conditions.",
      antidepressants: "Medications used to treat depression and other mood disorders.",
      topical_agents: "Drugs applied directly to the skin for local treatment of conditions like wounds, burns, or rashes.",
      general_creams: "Non-specific creams used for a variety of skin conditions including dryness, irritation, and minor infections.",
      anthelmintics: "Drugs used to treat infections with parasitic worms (helminths), such as roundworm, tapeworm, and flukes.",
      antituberculars: "Medications specifically used to treat tuberculosis (TB), a bacterial infection caused by Mycobacterium tuberculosis.",
      antiretrovirals: "Medications used to manage and treat HIV/AIDS by inhibiting the replication of the virus.",
      antihistamines: "Drugs that relieve allergy symptoms by blocking the effects of histamine in the body.",
      antidiarrheals: "Medications used to reduce or stop diarrhea, including oral rehydration solutions.",
      antiseptics: "Agents that prevent infection by inhibiting the growth of microorganisms on living tissue or surfaces.",
      hematinics: "Substances that improve the quality or quantity of blood, especially by increasing hemoglobin or red blood cells.",
      eye_ear_preparations: "Medications formulated for the treatment of eye or ear conditions, such as infections or inflammations."
    };

    // --- Dynamic Inventory Rendering ---
    // Renders the inventory UI, including categories, drugs, and batch controls.
    function renderInventory() {
      const inventoryColumn = document.getElementById('inventory-column');
      inventoryColumn.innerHTML = '';
      Object.keys(drugDatabase).forEach(cat => {
        // Calculate total quantity for the category.
        const count = drugDatabase[cat].reduce((sum, drug) => sum + drug.quantity, 0);

        // Create the category container.
        const drugCategory = document.createElement('div');
        drugCategory.className = 'drug-category';

        // Category header with dropdown logic (collapsed by default).
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.setAttribute('data-cat', cat);
        categoryHeader.setAttribute('tabindex', '0');
        categoryHeader.onclick = function() { toggleCategory(cat); };
        categoryHeader.onkeydown = function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleCategory(cat);
          }
        };
        // Dropdown arrow and category label.
        categoryHeader.innerHTML = `<span style="display:flex;align-items:center;">
          <span class="toggle-icon" id="toggle-icon-${cat}" style="font-size:18px;">►</span>
          ${getCategoryLabel(cat)} <span class="category-count" id="count-${cat}">(${count})</span>
        </span>`;
        // Info icon for category description popup.
        const infoIcon = document.createElement('span');
        infoIcon.className = 'info-icon';
        infoIcon.textContent = '?';
        infoIcon.setAttribute('aria-label', 'Show category info');
        infoIcon.setAttribute('title', 'Show category info');
        infoIcon.setAttribute('tabindex', '0');
        infoIcon.onclick = function(e) {
          e.stopPropagation();
          showCategoryInfo(cat);
        };
        infoIcon.onkeydown = function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showCategoryInfo(cat);
          }
        };
        categoryHeader.appendChild(infoIcon);

        // Drug list for this category (collapsed by default).
        const drugList = document.createElement('div');
        drugList.className = 'drug-list';
        drugList.id = cat;
        drugList.style.maxHeight = '0';

        // Render each drug in the category.
        drugDatabase[cat].forEach((drug, idx) => {
          const drugItem = document.createElement('div');
          drugItem.className = 'drug-item';

          // Render batch numbers with delete (×) controls.
          const batchDisplay = (drug.batchNumbers && drug.batchNumbers.length)
            ? drug.batchNumbers.map((batch, bidx) =>
                `<span style="font-size:12px;color:#007BFF;display:inline-block;position:relative;margin-right:6px;">
                  ${batch}
                  <span class="delete-batch" data-cat="${cat}" data-idx="${idx}" data-batchidx="${bidx}" title="Delete batch" style="color:#dc3545;cursor:pointer;font-weight:bold;position:absolute;top:-8px;right:-10px;font-size:14px;">×</span>
                </span>`
              ).join('')
            : `<span style="font-size:12px;color:#888;">No batch</span>`;

          const batchInputId = `batch-input-${cat}-${idx}`;

          // Color-code the quantity cell based on stock level.
          let qtyColor = '';
          if (drug.quantity >= 50) {
            qtyColor = 'green';
          } else if (drug.quantity >= 20) {
            qtyColor = '#ffc107'; // yellow
          } else {
            qtyColor = '#dc3545'; // red
          }

          // Drug row: name, batch controls, quantity, and delete drug button.
          drugItem.innerHTML = `
            <span>
              ${drug.name} ${batchDisplay}
              <input type="text" id="${batchInputId}" placeholder="Add batch" style="width:90px;font-size:12px;margin-left:6px;">
              <button type="button" class="add-batch-btn" data-cat="${cat}" data-idx="${idx}" style="font-size:12px;padding:2px 8px;margin-left:2px;">Add</button>
            </span>
            <span class="inventory-cell" data-quantity="${drug.quantity}" style="color:${qtyColor};font-weight:bold;">${drug.quantity}</span>
            <span class="delete-drug" title="Remove Drug" data-name="${drug.name}" data-category="${cat}">🗑️</span>
          `;
          drugList.appendChild(drugItem);
        });

        drugCategory.appendChild(categoryHeader);
        drugCategory.appendChild(drugList);
        inventoryColumn.appendChild(drugCategory);
      });
    }

    // Returns a user-friendly label for each category.
    function getCategoryLabel(cat) {
      switch(cat) {
        case 'antacids': return 'Antacids/PPIs';
        case 'vitamins': return 'Vitamin Supplements';
        case 'glaucoma': return 'Glaucoma Medications';
        case 'general_creams': return 'General Creams';
        case 'topical_agents': return 'Topical Agents';
        case 'antidepressants': return 'Antidepressants';
        case 'corticosteroids': return 'Corticosteroids';
        case 'antivirals': return 'Antivirals';
        case 'analgesics': return 'Analgesics';
        default: return cat.charAt(0).toUpperCase() + cat.slice(1).replace(/_/g, ' ');
      }
    }

    // --- Category Toggle (dropdown for each category) ---
    // Expands/collapses the drug list for a category.
    window.toggleCategory = function(categoryId) {
      const list = document.getElementById(categoryId);
      if (!list) return;
      const icon = document.getElementById(`toggle-icon-${categoryId}`);
      list.classList.toggle('expanded');
      if (icon) icon.textContent = list.classList.contains('expanded') ? '▼' : '►';
      list.style.maxHeight = list.classList.contains('expanded') ? '500px' : '0';
    };

    // --- Inventory Section Minimizer (retracted by default) ---
    // Controls the visibility of the entire inventory section.
    const inventorySection = document.getElementById('inventory-section');
    const inventoryToggleHeader = document.getElementById('inventory-toggle-header');
    const inventoryToggleArrow = document.getElementById('inventory-toggle-arrow');
    let inventoryVisible = false;
    inventoryToggleHeader.onclick = function() {
      inventoryVisible = !inventoryVisible;
      inventorySection.style.display = inventoryVisible ? '' : 'none';
      inventoryToggleArrow.textContent = inventoryVisible ? '▼' : '►';
    };

    // --- Transfer Section Minimizer (retracted by default) ---
    // Controls the visibility of the transfer medication section.
    const transferSection = document.getElementById('transfer-section');
    const transferToggleHeader = document.getElementById('transfer-toggle-header');
    const transferToggleArrow = document.getElementById('transfer-toggle-arrow');
    let transferVisible = false;
    transferToggleHeader.onclick = function() {
      transferVisible = !transferVisible;
      transferSection.style.display = transferVisible ? '' : 'none';
      transferToggleArrow.textContent = transferVisible ? '▼' : '►';
    };

    // --- Category Info Popup ---
    // Shows a modal with the description of the selected drug category.
    function showCategoryInfo(category) {
      const popup = document.getElementById('categoryPopup');
      document.getElementById('popupCategoryTitle').textContent = getCategoryLabel(category);
      document.getElementById('popupCategoryDescription').textContent = categoryDefinitions[category] || "";
      popup.classList.add('active');
    }
    window.closePopup = function() {
      document.getElementById('categoryPopup').classList.remove('active');
    };
    document.getElementById('categoryPopup').addEventListener('click', function(e) {
      if (e.target === this) closePopup();
    });

    // --- Theme Toggle ---
    // Switches between light and dark mode, and persists the choice.
    window.toggleTheme = function() {
      document.body.classList.toggle('dark-mode');
      const btn = document.querySelector('.theme-toggle');
      const isDark = document.body.classList.contains('dark-mode');
      btn.textContent = isDark ? '🌞' : '🌙';
      localStorage.setItem('darkMode', isDark);
    };
    // Initialize theme from localStorage on page load.
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = '🌞';
    }

    // --- Dynamic Drug Selection for Transfer ---
    // Populates the drug dropdown based on the selected category.
    document.getElementById('drugCategory').addEventListener('change', function() {
      const drugSelect = document.getElementById('drugSelection');
      drugSelect.innerHTML = '<option value="">Select Drug</option>';
      drugSelect.disabled = !this.value;
      document.getElementById('transferQuantity').max = ""; // Reset max when category changes
      if (this.value && drugDatabase[this.value]) {
        drugDatabase[this.value].forEach(drug => {
          const option = document.createElement('option');
          option.value = drug.name;
          option.textContent = `${drug.name} (${drug.quantity} available)`;
          option.dataset.quantity = drug.quantity;
          drugSelect.appendChild(option);
        });
      }
    });

    // --- Quantity Validation for Transfer ---
    // Sets the max attribute for the quantity input based on selected drug.
    document.getElementById('drugSelection').addEventListener('change', function() {
      const maxQuantity = this.selectedOptions[0]?.dataset.quantity;
      document.getElementById('transferQuantity').max = maxQuantity || "";
    });

    // --- Add batch number to existing drugs and handle batch deletion ---
    // Handles batch addition, batch deletion (with in-app confirmation), and drug deletion.
    document.getElementById('inventory-column').addEventListener('click', function(e) {
      // Add batch number to a drug.
      if (e.target.classList.contains('add-batch-btn')) {
        const cat = e.target.dataset.cat;
        const idx = parseInt(e.target.dataset.idx, 10);
        const input = e.target.previousElementSibling;
        const batchNum = input.value.trim();
        if (batchNum.length === 0) {
          alert('Please enter a batch number.');
          return;
        }
        if (!drugDatabase[cat][idx].batchNumbers.includes(batchNum)) {
          drugDatabase[cat][idx].batchNumbers.push(batchNum);
          renderInventory();
        } else {
          alert('Batch number already exists for this drug.');
        }
      }
      // Delete a drug from the inventory.
      if (e.target.classList.contains('delete-drug')) {
        const drugName = e.target.dataset.name;
        const category = e.target.dataset.category;
        if (confirm(`Are you sure you want to remove "${drugName}" from ${getCategoryLabel(category)}?`)) {
          const index = drugDatabase[category].findIndex(d => d.name === drugName);
          if (index > -1) {
            drugDatabase[category].splice(index, 1);
            renderInventory();
          }
        }
      }
      // Handle batch deletion with in-app notification.
      if (e.target.classList.contains('delete-batch')) {
        const cat = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'), 10);
        const batchidx = parseInt(e.target.getAttribute('data-batchidx'), 10);

        // Show an in-app notification for confirmation.
        const parent = e.target.closest('.drug-item');
        // Remove any previous notification in this drug row.
        const prevNotif = parent.querySelector('.batch-delete-notif');
        if (prevNotif) prevNotif.remove();

        const notif = document.createElement('div');
        notif.className = 'batch-delete-notif';
        notif.style.background = '#fff3cd';
        notif.style.color = '#856404';
        notif.style.border = '1px solid #ffeeba';
        notif.style.padding = '8px 12px';
        notif.style.borderRadius = '5px';
        notif.style.position = 'absolute';
        notif.style.zIndex = '10';
        notif.style.top = '-30px';
        notif.style.right = '0';
        notif.style.fontSize = '13px';
        notif.innerHTML = `
          Delete this batch number?
          <button class="confirm-delete-batch" style="margin-left:8px;background:#dc3545;color:#fff;border:none;padding:2px 8px;border-radius:3px;cursor:pointer;">Yes</button>
          <button class="cancel-delete-batch" style="margin-left:4px;background:#ccc;color:#333;border:none;padding:2px 8px;border-radius:3px;cursor:pointer;">No</button>
        `;
        parent.style.position = 'relative';
        parent.appendChild(notif);

        notif.querySelector('.confirm-delete-batch').onclick = function() {
          drugDatabase[cat][idx].batchNumbers.splice(batchidx, 1);
          renderInventory();
        };
        notif.querySelector('.cancel-delete-batch').onclick = function() {
          notif.remove();
        };
        return;
      }
    });

    // --- Analytics Rendering ---
    // Updates the analytics UI for top drugs and locations.
    function updateAnalytics() {
      // Top 5 drugs by transfer count.
      const drugsList = document.getElementById('topDrugsList');
      drugsList.innerHTML = '';
      Object.entries(transferCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .forEach(([drug, count]) => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${drug}</span> <span>${count} transfers</span>`;
          drugsList.appendChild(li);
        });
      // Top 5 delivery locations.
      const locationsList = document.getElementById('topLocationsList');
      locationsList.innerHTML = '';
      Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .forEach(([loc, count]) => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${loc}</span> <span>${count} deliveries</span>`;
          locationsList.appendChild(li);
        });
    }

    // --- Add Drug Form Logic (with batch number and in-app error notification) ---
    // Handles adding new drugs or batches to the inventory.
    document.getElementById('addDrugForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const category = document.getElementById('newDrugCategory').value;
      const name = document.getElementById('newDrugName').value.trim();
      const quantity = parseInt(document.getElementById('newDrugQuantity').value, 10);
      const batch_id = document.getElementById('add_batch_id').value;
      const manufacturingDate = document.getElementById('manufacturing_date').value;
      const expiryDate = document.getElementById('expiry_date').value;

      // Remove any previous error messages.
      const prevError = this.parentNode.querySelector('.error');
      if (prevError) prevError.remove();

      // Validation for all required fields.
      if (!category || !name || !quantity || !batch_id || !manufacturingDate || !expiryDate) {
        showError(this, "Please fill in all fields!");
        return;
      }
      if (name.length === 0) {
        showError(this, "Drug name cannot be empty!");
        return;
      }
      if (new Date(expiryDate) <= new Date(manufacturingDate)) {
        showError(this, "Expiry date must be after manufacturing date!");
        return;
      }
      if (!drugDatabase[category]) drugDatabase[category] = [];
      const existingDrug = drugDatabase[category].find(drug => drug.name.toLowerCase() === name.toLowerCase());
      if (existingDrug) {
        existingDrug.quantity += quantity;
        if (!existingDrug.batchNumbers.includes(batch_id)) {
          existingDrug.batchNumbers.push(batch_id);
        }
      } else {
        drugDatabase[category].push({ name, quantity, batchNumbers: [batch_id] });
      }
      // Update inventory display after adding.
      renderInventory();
      // Show a success message for user feedback.
      const successMsg = document.createElement('div');
      successMsg.className = 'success';
      successMsg.textContent = `${quantity} ${name} added to ${getCategoryLabel(category)} inventory!`;
      this.parentNode.insertBefore(successMsg, this.nextSibling);
      this.reset();
      setTimeout(() => successMsg.remove(), 5000);
    });

    // --- Helper to show in-app error messages ---
    // Displays a temporary error message below the form.
    function showError(form, message) {
      const prevError = form.parentNode.querySelector('.error');
      if (prevError) prevError.remove();
      const errorMsg = document.createElement('div');
      errorMsg.className = 'error';
      errorMsg.textContent = message;
      form.parentNode.insertBefore(errorMsg, form.nextSibling);
      setTimeout(() => errorMsg.remove(), 5000);
    }

    // --- Keyboard accessibility for category toggle ---
    // Allows toggling categories with keyboard for accessibility.
    document.getElementById('inventory-column').addEventListener('keydown', function(e) {
      if (e.target.classList.contains('category-header') && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        const cat = e.target.getAttribute('data-cat');
        window.toggleCategory(cat);
      }
    });

    // --- Dynamic suggestions for Add New Batch drug name ---
    // Populates the datalist for drug name suggestions based on selected category.
    document.getElementById('newDrugCategory').addEventListener('change', function() {
      const category = this.value;
      const datalist = document.getElementById('drugSuggestions');
      datalist.innerHTML = '';
      if (category && drugDatabase[category] && drugDatabase[category].length > 0) {
        drugDatabase[category].forEach(drug => {
          const option = document.createElement('option');
          option.value = drug.name;
          datalist.appendChild(option);
        });
      }
      // If no drugs in category, datalist will be empty, so user can type a new drug name
    });

    // --- Initial Rendering ---
    // Renders inventory, analytics, and animates sections on page load.
    renderInventory();
    updateAnalytics();
    document.querySelectorAll('.section').forEach(s => s.classList.add('visible'));
  });
  </script>
</body>
</html>